FROM openjdk:8

# install certbot
ADD ./jessie-backports.list /etc/apt/sources.list.d/jessie-backports.list
RUN apt-get update && apt-get install -y certbot -t jessie-backports dos2unix

# main directory where the certificates are generated. This directory should be mounted to the host since other
# directories inside (e.g. "live") use symlinks which should not be broken by mounting
ENV main_dir="/etc/letsencrypt"

# webroot directory which is used for the letsencrypt acme challenge, this is mounted from the nginx web proxy
ENV webroot_dir="/usr/share/nginx/html"

# mail address that gets informed when the certificate is about to run out
ENV certificate_email=florian.kleedorfer@researchstudio.at

# java key store password
ENV key_store_password=changeit

# the certificate files "privkey.pem" and "fullchain.pem" are generated by letsencrypt certbot in the folder "live"
# and subfolder "matchat.org" (as symlinks that point to an archive folder). The certificate is valid for the domain
# "matchat.org" and the subdomains "www.matchat.org" and "node.matchat.org" (see certificate-request-and-renew.sh)
ENV key_pem_file="$main_dir/live/matchat.org/privkey.pem"
ENV cert_pem_file="$main_dir/live/matchat.org/fullchain.pem"

# the java key store file is generated from the .pem files in the same folder.
ENV pfx_store_file="$main_dir/live/matchat.org/t-key-cert.pfx"
ENV jks_store_file="$main_dir/live/matchat.org/t-keystore.jks"

ADD certificate-request-and-renew.sh /usr/local/bin/certificate-request-and-renew.sh
RUN chmod +x /usr/local/bin/certificate-request-and-renew.sh
RUN dos2unix /usr/local/bin/certificate-request-and-renew.sh


